<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout.html}">
<div layout:fragment="content">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Kết quả tìm kiếm</title>
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
            .user-card {
                border: 1px solid #ddd;
                padding: 15px;
                margin-bottom: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .user-card img {
                border-radius: 50%;
                width: 60px;
                height: 60px;
                object-fit: cover;
            }

            .user-card .d-flex {
                justify-content: space-between;
                align-items: center;
            }

            .user-card .user-info {
                display: flex;
                align-items: center;
            }

            .user-card .user-info h5 {
                margin: 0 10px 0 0;
            }

            .user-card .btn {
                width: 120px;
                background-color: #007bff;
                color: white;
                border-radius: 4px;
                padding: 10px;
                font-size: 14px;
            }

            .user-card .btn:hover {
                background-color: #0056b3;
            }

            .user-card .user-info p {
                margin-bottom: 0;
            }
        </style>
    </head>
    <body>

    <div class="container mt-4" style="max-width: 50%;">
        <div id="results" class="row"></div>
    </div>

    <script>
        $(document).ready(function () {
            // Lấy phần sau dấu gạch chéo trong URL
            const pathname = window.location.pathname;
            const name = pathname.split('/').pop();

            if (name) {
                // Gửi yêu cầu API tìm kiếm
                $.ajax({
                    url: 'http://localhost:8080/user/search',
                    method: 'GET',
                    data: { name: name },
                    success: function (response) {
                        if (response.data && response.data.length > 0) {
                            const usersHtml = response.data.map(user => `
                            <div class="col-md-12">
                                <div class="user-card" data-user-id="${user.id}">
                                    <div class="d-flex">
                                        <div class="user-info">
                                            <img src="${user.avatar}" alt="${user.firstName} ${user.lastName}" class="me-3">
                                            <div>
                                                <h5>${user.firstName} ${user.lastName}</h5>
                                                <p class="text-muted">${user.about || 'Không có thông tin.'}</p>
                                            </div>
                                        </div>
                                        <button class="btn add-friend-btn">Kết bạn</button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                            $('#results').html(usersHtml);
                        } else {
                            $('#results').html('<p>Không tìm thấy người dùng nào.</p>');
                        }
                    },
                    error: function () {
                        $('#results').html('<p>Đã xảy ra lỗi khi tìm kiếm.</p>');
                    }
                });
            } else {
                $('#results').html('<p>Không có từ khóa tìm kiếm.</p>');
            }

            // Xử lý sự kiện nhấn nút "Kết bạn"
            $(document).on('click', '.add-friend-btn', function () {

                const userId = $(this).closest('.user-card').data('user-id');
                const receiverId = { receiverId: userId };

                const token = localStorage.getItem('token');  // Hoặc bạn có thể lấy từ cookies

                if (!token) {
                    alert('Bạn cần đăng nhập để thực hiện yêu cầu này.');
                    return;
                }

                $.ajax({
                    url: 'http://localhost:8080/friendship/add',
                    method: 'POST',
                    contentType: 'application/json',
                    headers: {
                        'Authorization': `Bearer ${token}`  // Thêm token vào header
                    },
                    data: JSON.stringify(receiverId),
                    success: function (response) {
                        if (response.status === 200) {
                            alert(response.data);  // Hiển thị thông báo thành công
                        } else {
                            alert(response.data);  // Hiển thị thông báo lỗi
                        }
                    },
                    error: function () {
                        alert('Đã xảy ra lỗi khi gửi yêu cầu kết bạn.');
                    }
                });
            });
        });
    </script>
    </body>
</div>
</html>
